{"componentChunkName":"component---src-components-templates-blog-post-js","path":"/how-to-add-custom-KPI-tracking-in-Google-analytics","result":{"data":{"markdownRemark":{"frontmatter":{"title":"How to track custom KPIs with Google Analytics","date":"2020-09-10","tags":["API","Google Analytics","AJAX"]},"html":"<blockquote>\n<p>TL;DR: I sent the data through an AJAX request to an end point of google analytics. Sounds easy, but this isn't the conventional way to use Google Analytics. Follow <a href=\"/blog/send-custom-events-to-google-analytics\">this article</a> for step-by-step instructions</p>\n</blockquote>\n<h2>The task that I was trying to complete</h2>\n<p>I needed a away to get a analytics report for the number of users whose premium plan is active on a particular day. This would then become a company KPI for the product.</p>\n<h2>First approach <em>TL;DR: Didn't Work</em></h2>\n<p>We had all our customer data on firebase real time database. After some digging, I found that firebase too has an analytics dashboard called firebase analytics. There we could set custom user properties. These custom properties could then be used to make audiences that we wanted to monitor.</p>\n<p>I decided to make a custom property called <code>isPremiunActive</code> for each user and run a scheduled firebase function everyday. This function would get all the premium users and set the <code>isPremiunActive</code> property on their profile as <code>true</code> if their plan had not yet expired, else it would set it to <code>false</code>.<br>\n<em>Later we would automatically write the <code>isPremiunActive</code> property as <code>true</code> whenever the user buys a new plan. Then the function would only need to set the attribute to <code>false</code></em></p>\n<h4>Why this did not work?</h4>\n<p>The firebase SDK method <code>setUserProperty</code>, that was supposed to set the value of this custom user property, did not take any parameters like user ID or email or any such argument that could help us run the function or a particular user. </p>\n<p>After a few hours of reading the documentation and contacting firebase support, I realised that this method was only supposed to be used from within the app(<em>during a logged in session</em>), NOT from cloud functions. The user would be identified using the firebase authentication system that we had already setup for the client-side application.</p>\n<blockquote>\n<p>Firebase support, if you are reading this(<em>highly unlikely</em>), I was very happy that you responded to my queries very quickly and thoroughly. You helped me understand what the firebase analytics feature was actually meant for and how it is <strong>not</strong> what I was looking for.</p>\n</blockquote>\n<h2>Second approach: <em>The one that worked</em></h2>\n<p>I started searching for a way to raise custom events on Google analytics using some API endpoint. At first, the only API that I could find was the <code>Google Analytics Reporting V4</code>.\nThis API was pitched <em>everywhere</em> as a way to get analytics data by performing all sorts of complex queries (<em>thanks to the number of query parameters that it provides. THERE ARE A TON!</em>)\nBut since we can only get data, this API did not solve our problem. The only reason I even considered exploring it was because the only endpoint that it had, handled post requests (<em>Little did I know that <code>POST</code> does not always mean sending data to be stored somewhere you want</em>) </p>\n<p>At this point I had lost all hopes and decided that I would just store the data for each day on firebase (<em>In a somewhat ordered fashion for now</em>) and get the data from there. Later, we could send all this data to <strong>Google Data Studio</strong> to get a more graphical representation of the data.</p>\n<h4>Something good finally happened (<em>well maybe not good, but....</em>)</h4>\n<p>Our main company product is a web app which works along with a browser extension. While I was busy with this, we were at the point of releasing a new version of the browser extension.\nWhen we tried to publish the new extension on Firefox, the new version was not approved for some reasons. <br>\nThe <strong>good</strong> part was that they sent a thorough report of why they did not approve it and how to fix the problems. In the report there was a link pointing to an article titled <a href=\"https://blog.mozilla.org/addons/2016/05/31/using-google-analytics-in-extensions/\">Using Google Analytics in extensions</a></p>\n<p><strong>Following is an excerpt from that article</strong>\n*This blog post is meant to show the safer ways of using GA, not advocate its unrestricted use.</p>\n<p>I created a branch of one of my add-ons to serve as a demo. The add-on is a WebExtension that injects a content script into some AMO pages to add links that are useful to admins and reviewers. The diff for the branch shouldnâ€™t take much time to read and understand. It mostly comes down to this XHR:*</p>\n<pre><code>let request = new XMLHttpRequest();\nlet message =\n  \"v=1&#x26;tid=\" + GA_TRACKING_ID + \"&#x26;cid= \" + GA_CLIENT_ID + \"&#x26;aip=1\" +\n  \"&#x26;ds=add-on&#x26;t=event&#x26;ec=AAA&#x26;ea=\" + aType;\n\nrequest.open(\"POST\", \"https://www.google-analytics.com/collect\", true);\nrequest.send(message);\n</code></pre>\n<p>I pasted the above script into a new file, and customized it to send function like this</p>\n<pre><code>let hitGA = () => {\n  const GA_TRACKING_ID = \"your GA tracking ID\"\n  const GA_CLIENT_ID = \"steps to get this will be given in the resources below\"\n\n  const event = {\n    category: \"pricing\",\n    action: \"counted\",\n    label: \"num_active_users\",\n    value: 71\n  }\n  let request = new XMLHttpRequest();\n  let message = \n  `v=1&#x26;tid=${GA_TRACKING_ID}&#x26;cid=${GA_CLIENT_ID}&#x26;aip=1&#x26;ds=add-on&#x26;t=event&#x26;ec=${event.category}&#x26;ea=${event.action}&#x26;el=${event.label}&#x26;ev=${event.value}`\n\n  request.open(\"POST\", \"https://www.google-analytics.com/collect\", true);\n  request.send(message);\n\n}\n</code></pre>\n<p>And then, I copied this whole thing into Firefox's console and <em>volla</em>; I got a successful <strong>200 OK</strong> Response. </p>\n<p><strong><em>But,</em></strong><br>\nThe event was not seen in google analytics. I thought that this might had been because google had applied some sort of filtering system for incoming request to avoid tracking <em>bogus requests</em> like these.\nSo, frustrated and tired after the day's effort I decided to sleep on it.</p>\n<p><strong><em>But,</em></strong><br>\nThe next day, when I checked Google analytics <strong>again</strong> for the event (<em>with no hope whatsoever</em>) the event was there!!!</p>\n<p>Finally!</p>\n<p>So I implemented the changes in the firebase function and then tried to test it after deployment. It executed successfully and I got a proper response but again there was no such event in analytics.\nTurns out that it takes time to track events sent directly from firebase functions. <em>Still don't know the reason for this delay</em>ðŸ¤” (<em>Why GOOGLE? <strong>WHY?!!</strong></em>)</p>\n<hr>\n<p>So, like every good story, I successfully committed the code and the program ran happily ever after.</p>\n<h2>Links on the web that helped me get through this problem</h2>\n<ol>\n<li><a href=\"https://www.owox.com/blog/use-cases/google-analytics-client-id/\">How to find <code>GA_CLIENT_ID</code></a></li>\n<li><a href=\"https://stackoverflow.com/questions/63808048/add-custom-user-property-through-firebase-function\">StackOverflow question</a> that I opened</li>\n<li><a href=\"https://developers.google.com/analytics/devguides/collection/protocol/v1/parameters#events\">Docs</a> that were helpful</li>\n<li>And of course, <a href=\"https://blog.mozilla.org/addons/2016/05/31/using-google-analytics-in-extensions/\"><strong><em>the lifesaver</em></strong></a></li>\n</ol>"}},"pageContext":{"slug":"how-to-add-custom-KPI-tracking-in-Google-analytics"}},"staticQueryHashes":["2199005656","3159585216"]}